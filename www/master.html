<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/assets/css/room.css">
    <!-- Dependencies -->
    <script src="/assets/bower_components/webrtc-adapter/release/adapter.js"></script>
    <script src="/assets/js/socket.io.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/mediaconnection.js"></script>
    <script src="/assets/js/signalling.js"></script>
    <script src="/assets/js/peerconnection.js"></script>
    <title>Room</title>
</head>
<body>
    <!-- Main container -->
    <div class="container" id="main-container">
        <!-- Media container -->
        <div id="media-container">
            <!-- Local media -->
            <div id="local-media-container">
                <video ></video>
            </div>
            <!-- Remote media -->
            <div id="remote-media-container">
                <video ></video>
            </div>
        </div>
        <!-- Control container -->
        <div id="control-container">
            <!-- [Start] Media control -->
            <div id="media-control">
                <!-- Stream control -->
                <div id="stream-control">
                    <p>Local</p>
                    <button id="local-control-call" value="call">Call</button>
                    <button id="local-control-play" value="play" disabled=true>Play</button>
                    <button id="local-control-pause" value="pause">Pause</button>
                    <button id="local-control-stop" value="stop">Stop</button>
                    <p>Remote</p>
                    <button id="remote-control-play" value="play" disabled=true>Play</button>
                    <button id="remote-control-pause" value="pause">Pause</button>
                    <button id="remote-control-stop" value="stop">Stop</button>
                </div>
                <!-- Quality control -->
                <div id="quality-control">
                    <div id="quality-control-local">
                        <p>Local</p>
                        <input type="radio" value="sd" checked=true name="quality-local">SD</input>
                        <input type="radio" value="hq" name="quality-local">HQ</input>
                        <input type="radio" value="hd" name="quality-local">HD</input>
                    </div>
                    <div id="quality-control-remote">
                        <p>Remote</p>
                        <input type="radio" value="sd" name="quality-remote" disabled>SD</input>
                        <input type="radio" value="hq" name="quality-remote" disabled>HQ</input>
                        <input type="radio" value="hd" name="quality-remote" disabled>HD</input>
                    </div>
                </div>
                <!-- Media type control -->
                <div id="type-control">
                    <div id="type-control-local">
                        <p>Local</p>
                        <input type="radio" name="quality-local" checked>Both</input>
                        <input type="radio" name="quality-local">Video only</input>
                        <input type="radio" name="quality-local">Audio only</input>
                    </div>
                    <div id="type-control-remote">
                        <p>Remote</p>
                        <input type="radio" name="quality-remote" disabled>Audio only</input>
                        <input type="radio" name="quality-remote" disabled>Video only</input>
                        <input type="radio" name="quality-remote" disabled>Both</input>
                    </div>
                </div>
            </div>
            <!-- [End Media control] -->

            <!-- Crypto control -->
            <div id="crypto-control">
                <p>RSA key size</p>
                <input type="radio" name="crypto">1024</input>
                <input type="radio" name="crypto">2048</input>
                <input type="radio" name="crypto">2048</input>
                <p>ECDSA key size</p>
                <input type="radio" name="crypto">256</input>
                <input type="radio" name="crypto">368</input>
                <input type="radio" name="crypto">512</input>
            </div>
        </div>
    </div>
</body>
<script>
    // Setup variables

    var localVideo = document.getElementById("local-media-container").querySelector("video");
    var remoteVideo = document.getElementById("remote-media-container").querySelector("video");

    var localMediaControl = {
        call : document.getElementById("local-control-call"),
        play : document.getElementById("local-control-play"),
        pause : document.getElementById("local-control-pause"),
        stop : document.getElementById("local-control-stop")
    };
    var remoteMediaControl = {
        play : document.getElementById("remote-control-play"),
        pause : document.getElementById("remote-control-pause"),
        stop : document.getElementById("remote-control-stop")
    };
    var localMediaQualityList = document.getElementById("quality-control-local").querySelectorAll("input");
    var remoteMediaQualityList = document.getElementById("quality-control-remote").querySelectorAll("input");
    var localMediaTypeList = document.getElementById("type-control-local").querySelectorAll("input");
    var remoteMediaTypeList = document.getElementById("type-control-remote").querySelectorAll("input");

    var signallingMessage = {
        type : "",
        message : {}
    }

    // End setup variables

    // Start define event listeners
    
    // Media control listener
    Object.keys(localMediaControl).forEach((key) => {
        localMediaControl[key].addEventListener("click", (e) => {
            onlocalcontrolchange(localMediaControl[key].value);
        });
    });
    Object.keys(remoteMediaControl).forEach((key) => {
        remoteMediaControl[key].addEventListener("click", (e) => {
            onremotecontrolchange(remoteMediaControl[key].value);
        });
    });

    // Media quality listener
    localMediaQualityList.forEach((quality) => {
        quality.addEventListener("click", (e) => {
            onlocalqualitychange(quality.value);
        })
    });
    remoteMediaQualityList.forEach((quality) => {
        quality.addEventListener("click", (e) => {
            // Quality radio button click handler
        })
    });

    // Media type listener
    localMediaTypeList.forEach((type) => {
        type.addEventListener("click", (e) => {
            // Type radio button click handler
        })
    });
    remoteMediaTypeList.forEach((type) => {
        type.addEventListener("click", (e) => {
            // Type radio button click handler
        })
    });

    // End define event listeners

    // Start define event handler

    var onlocalcontrolchange = function(control){
        switch(control){
            case "call" :
                mediaPeer();
                break;
            case "play" :
                MediaConnection.control.play(localVideo);
                localMediaControl.play.disabled = true;
                localMediaControl.pause.disabled = false;
                localMediaControl.stop.disabled = false;
                break;
            case "pause" :
                MediaConnection.control.pause(localVideo);
                localMediaControl.play.disabled = false;
                localMediaControl.pause.disabled = true;
                localMediaControl.stop.disabled = false;
                break;
            case "stop" :
                MediaConnection.control.stop(localVideo);
                localMediaControl.play.disabled = false;
                localMediaControl.pause.disabled = true;
                localMediaControl.stop.disabled = true;
                break
            default :
                console.log("Error")
                break;
        };
    };

    var onremotecontrolchange = function(control){
        switch(control){
            case "play" :
                break;
            case "pause" :
                break;
            case "stop" :
                break
            default :
                console.log("Error")
                break;
        };
    };

    var onlocalqualitychange = function(quality){
        switch(quality){
            case "sd" :
                mediaPeer(Constraint.constraintsBuilder(Constraint.video.standard, Constraint.audio.default, Constraint.facemode.env));
                break;
            case "hq" :
                mediaPeer(Constraint.constraintsBuilder(Constraint.video.highQuality, Constraint.audio.default, Constraint.facemode.env));
                break;
            case "hd" :
                mediaPeer(Constraint.constraintsBuilder(Constraint.video.highDefinition, Constraint.audio.default, Constraint.facemode.env));
                break;
            default :
                console.log("Error");
                break;
        }
    };

    // End define event handler

    // Start service
    // Override media handler
    MediaConnection.handler.onactive = function(){

    };
    MediaConnection.handler.onaddtrack = function(){
        
    };
    MediaConnection.handler.oninactive = function(){
        
    };
    MediaConnection.handler.onremotetrack = function(){
        
    };

    // Signalling
    signalling.joinRoom();

    // Register peerconnection event handler
    peerconnection.onoffer = function(offer){
        console.log("On Offer\n", offer);
        rtcPeerConnection.setRemoteDescription(offer).then(() => {
            console.log("Remote description", rtcPeerConnection.remoteDescription);
            console.log("Get user media");
            return MediaConnection.start(localVideo);
        })
        .then((stream) => {
            console.log("Create answer");
            return peerconnection.createAnswer(stream);
        })
        .then((answer) => {
            console.log("Answer\n", offer);
            return rtcPeerConnection.setLocalDescription(answer);
        })
        .then(() => {
            console.log("Local description\n", rtcPeerConnection.localDescription);
            signallingMessage.type = "answer";
            signallingMessage.message = rtcPeerConnection.localDescription;
            signalling.sendRoom(signallingMessage);
            console.log("Blast message\n", signallingMessage);
        });
    };
    
    peerconnection.onanswer = function(answer){
        console.log("On Answer\n", answer);
        rtcPeerConnection.setRemoteDescription(answer);
        console.log("Remote description\n", rtcPeerConnection.remoteDescription);
    };

    // Register signal plane handler
    signalling.onMessage("room", (message) => {
        console.log(message);
    });
    signalling.onMessage("offer", (data) => {
        peerconnection.onoffer(data);
    });
    signalling.onMessage("answer", (data) => {
        peerconnection.onanswer(data);
    });

    // Register peerconnection handler
    peerconnection.onaddtrack(function(e){
        MediaConnection.onaddtrack(remoteVideo,e.stream)
    });

    // End logic

    // Additional function
    function mediaPeer(constraint){
        MediaConnection.start(localVideo, constraint).then(stream => {
            console.log("Get user media");
            peerconnection.createOffer(stream).then((offer) => {
                console.log("Create offer");
                console.log("Offer\n", offer);
                return rtcPeerConnection.setLocalDescription(offer);
            }).then(() => {
                console.log("Local description\n", rtcPeerConnection.localDescription);
                signallingMessage.type = "offer";
                signallingMessage.message = rtcPeerConnection.localDescription;
                signalling.sendRoom(signallingMessage);
                console.log("Blast message", signallingMessage);
            });
        });
    }
    // End additional function
</script>
</html>